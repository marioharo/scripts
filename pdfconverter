#!/bin/zsh

# --- Configuraci√≥n por defecto ---
OUT_DIR="./pdf-convertido"
PREFIX=""
EXT=""

# Funci√≥n de ayuda (Help)
usage() {
    echo "Use: to-pdf -t [ppt|doc] [-p prefijo]"
    echo "Options:"
    echo "  -t : Tipo de archivo a convertir (ppt o doc) [Obligatorio]"
    echo "  -p : Prefijo opcional para el nombre del archivo"
    echo "  -h : Help"
    exit 1
}

# --- Procesamiento de Argumentos (Dise√±o de Interfaz) ---
while getopts "t:p:h" opt; do
    case $opt in
        t) [[ "$OPTARG" == "ppt" ]] && EXT="pptx"
           [[ "$OPTARG" == "doc" ]] && EXT="docx" ;;
        p) PREFIX="$OPTARG" ;;
        h) usage ;;
        *) usage ;;
    esac
done

# Validar que el tipo fue seleccionado
if [[ -z "$EXT" ]]; then
    echo "‚ùå Error: Debes especificar el tipo con -t [ppt|doc]"
    usage
fi

# --- L√≥gica de Sistema ---

# 1. Buscar archivos
files=(*.$EXT)
total=${#files[@]}

if [[ ! -e ${files[1]} ]]; then # Verifica si el primer elemento existe
    echo "‚ùå No se encontraron archivos .$EXT en este directorio."
    exit 1
fi

# 2. Reconfirmaci√≥n
echo "üìù Tipo: $EXT | Carpeta: $OUT_DIR | Prefijo: ${PREFIX:-"(ninguno)"}"
echo -n "‚ö†Ô∏è  Se procesar√°n $total archivos. ¬øContinuar? (y/n): "
read -k 1 res
echo ""

if [[ $res != "y" && $res != "Y" ]]; then
    echo "üö´ Operaci√≥n cancelada."
    exit 0
fi

# 3. Preparar entorno
[[ ! -d "$OUT_DIR" ]] && mkdir -p "$OUT_DIR"

# 4. Ejecuci√≥n del Core (LibreOffice)
echo "üöÄ Convirtiendo..."
/Applications/LibreOffice.app/Contents/MacOS/soffice --headless --convert-to pdf *.$EXT --outdir "$OUT_DIR"

# 5. L√≥gica de Prefijo (Transformaci√≥n)
if [[ -n "$PREFIX" ]]; then
    echo "üè∑Ô∏è  Aplicando prefijo '$PREFIX'..."
    for f in "$OUT_DIR"/*.pdf; do
        filename=$(basename "$f")
        # Solo renombra si no tiene ya el prefijo (evita duplicados)
        if [[ "$filename" != "$PREFIX"* ]]; then
            mv "$f" "$OUT_DIR/$PREFIX$filename"
        fi
    done
fi

echo "‚úÖ Proceso completado. Archivos en: $OUT_DIR"
